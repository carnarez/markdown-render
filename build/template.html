<!DOCTYPE html>
<html>

  <head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">

    <!-- metatags -->
    <title>{{ title }}</title>
    <meta name="title" content="{{ title }}">
    <meta name="description" content="{{ description }}">
    <meta property="article:author" content="{{ author }}">
    <meta property="article:published_time" content="{{ date }}">
    <meta property="og:type" content="article">
    <meta property="og:url" content="{{ url }}">
    <meta property="og:title" content="{{ title }}">
    <meta property="og:description" content="{{ description }}">
    <meta property="og:image" content="{{ image }}">
    <link rel="canonical" href="{{ canonical or url }}">
    <link rel="icon" href="favicon.ico" type="image/png">

    <!-- styling and color scheme -->
    <link rel="stylesheet" href="{{ root | trim("/") }}/style.css">
    {% if path != "" %}
    <link rel="stylesheet" href="style.css">
    {% endif %}

    <!-- theme toggler -->
    <script>
      function setTheme(name) {
        localStorage.setItem("theme", name);
        document.documentElement.className = name;
      }

      function toggleTheme() {
        if (localStorage.getItem("theme") === "light") {
          setTheme("dark");
        } else if (localStorage.getItem("theme") === "dark") {
          setTheme("dimmed");
        } else {
          setTheme("light");
        }
      }

      if (
        localStorage.getItem("theme") === "dark" ||
        (
          !("theme" in localStorage) &&
          window.matchMedia("(prefers-color-scheme: dark)").matches
        )
      ) {
        setTheme("dark");
      } else if (localStorage.getItem("theme") === "dimmed") {
        setTheme("dimmed");
      } else {
        setTheme("light");
      }
    </script>

    <!-- progress indicator -->
    <script>
      window.addEventListener("scroll", () => {
        const scrolled = 100 * window.scrollY / (document.querySelector("article").offsetHeight - window.innerHeight);
        document.querySelector("#scroller").style.width = scrolled + "%";
      });
    </script>

    <script>
      // keyboard shortcuts
      window.addEventListener("keyup", (event) => {
        const key = event.key;

        if (event.srcElement.tagName === "BODY") {
          if (key === "<") {
            window.location.href = "{{ prev }}";
          } else if (key === ">") {
            window.location.href = "{{ next }}";
          } else if (key === ".") {
            toggleSidebar("#overlay-menu");
          } else if (key === "/") {
            toggleSidebar("#overlay-search", "#search-input");
          }
        }

        if (event.srcElement.tagName === "INPUT" && key === "Escape") event.srcElement.blur();
      });
    </script>

    <!-- show/hide sidebar -->
    <script>
      // hide the sidebar while unblurring the rest
      function hideSidebar(asideSelector) {
        const aside = document.querySelector("aside" + asideSelector),
              naside = document.querySelector("aside:not(" + asideSelector + ")"),
              article = document.querySelector("article"),
              scroller = document.querySelector("#scroller");

        aside.style.margin = "0 0 0 -100vw";
        aside.style.height = "auto";
        aside.style.overflow = "auto";

        naside.style.height = "auto";
        naside.style.overflow = "auto";

        article.style.filter = "none";
        article.style.height = "auto";
        article.style.overflow = "auto";

        scroller.style.height = "1px";
      }

      // show the sidebar while blurring the rest
      function showSidebar(asideSelector) {
        const aside = document.querySelector("aside" + asideSelector),
              naside = document.querySelector("aside:not(" + asideSelector + ")"),
              article = document.querySelector("article"),
              scroller = document.querySelector("#scroller");

        aside.style.margin = "0";
        aside.style.height = "auto";
        aside.style.overflow = "auto";

        naside.style.margin = "0 0 0 -100vw";
        naside.style.height = aside.offsetHeight + "px";
        naside.style.overflow = "hidden";

        article.style.filter = "blur(6px)";
        article.style.height = aside.offsetHeight + "px";
        article.style.overflow = "hidden";

        scroller.style.height = "0";
      }

      // wrapper function
      function toggleSidebar(asideSelector, focusSelector = undefined) {
        const aside = document.querySelector("aside" + asideSelector);
        if (aside.style.marginLeft === "" || aside.style.marginLeft === "-100vw") {
          showSidebar(asideSelector);
          if (focusSelector !== undefined) document.querySelector(focusSelector).focus();
        } else {
          hideSidebar(asideSelector);
        }
      }
    </script>

    <!-- search via lunr; json file will be cached after first query -->
    <script>
      function lunrSearch() {
        fetch("{{ root | trim("/") }}/lunr-index.json")
          .then(response => response.json())
          .then(data => {
            const prose = data.documents,
                  index = lunr.Index.load(data.indexed),
                  results = [],
                  input = document.querySelector("#search-input").value,
                  output = document.querySelector("#search-output");

            if (input.length > 2) {
              index.search(input).forEach(match => {
                const path = prose[match.ref][0].replaceAll("/", " &gt; "),
                      title = prose[match.ref][1],
                      text = prose[match.ref][2];

                Object.keys(match.matchData.metadata).forEach(attr => {
                  match.matchData.metadata[attr].text.position.forEach(arr => {
                    const li = document.createElement("li"),
                          pos = parseInt(arr[0]),
                          len = parseInt(arr[1]);
                 
                    li.innerHTML = `
                      <a
                        class="search-result"
                        href="{{ root | trim("/") }}/${match.ref}"
                        onclick="toggleSidebar('#overlay-search')"
                      >
                        <div class="title">${path} &gt; ${title}</div>
                        <div class="text">
                          ${text.slice(Math.max(0, pos - 100), pos)}
                          <mark>${text.slice(pos, pos + len)}</mark>
                          ${text.slice(pos + len, Math.min(pos + len + 100, text.length))}
                        </div>
                      </a>
                    `;
                 
                    results.push(li);
                  });
                });

              });
            }

            output.replaceChildren(...results);

            showSidebar("#overlay-search");
          });
      }

      function resetSearch() {
        const input = document.querySelector("#search-input"),
              output = document.querySelector("#search-output");

        if (input.value.length > 0) {
          input.value = "";
          output.replaceChildren();
        }

        input.focus();
      }
    </script>

    <!-- external javascript libraries -->
    {% if highlight %}
    <script
      defer
      src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/highlight.min.js"
      onload="hljs.highlightAll()"
    ></script>
    {% endif %}
    {% if katex %}
    <script
      defer
      src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.2/katex.min.js"
    ></script>
    <script
      defer
      src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.2/contrib/auto-render.min.js"
      onload="renderMathInElement(
        document.body,
        {
          delimiters: [
            {
              left: '$$',
              right: '$$',
              display: true
            },
            {
              left: '$',
              right: '$',
              display: false
            },
          ]
        }
      )"
    ></script>
    {% endif %}
    <script
      defer
      src="https://cdnjs.cloudflare.com/ajax/libs/lunr.js/2.3.9/lunr.min.js"
    ></script>
    {% if mermaid %}
    <script src="{{ root | trim("/") }}/mermaid.js"></script>
    <script
      defer
      src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/9.1.7/mermaid.min.js"
      onload="mermaidInitialize()"
    ></script>
    {% endif %}

  </head>

  <body>

    <!-- show scrolling progress -->
    <div id="scroller"></div>

    <!-- buttons -->
    <nav>
      <span class="button sidebar" onclick="toggleSidebar('#overlay-menu')"></span>
      <span class="button search" onclick="toggleSidebar('#overlay-search', '#search-input')"></span>
      <span class="logo"></span>
      {% if repo %}
      <a class="button repo" href="{{ repo }}"></a>
      {% endif %}
      <span class="button theme" onclick="toggleTheme()"></span>
    </nav>

    <main>

      <!-- table of contents -->
      <aside id="overlay-menu">
        <div class="menu">
          {{ menu }}
          {{ toc }}
        </div>
        <div class="keys">
          <span><kbd>Esc</kbd> unfocus</span>
          <span><kbd>.</kbd> menu</span>
          <span><kbd>&lt;</kbd> previous</span>
          <span><kbd>&gt;</kbd> next</span>
          <span><kbd onclick="toggleSidebar('#overlay-search', '#search-input')">/</kbd> search</span>
        </div>
      </aside>
      <script>
        document.querySelectorAll("#overlay-menu a").forEach(a => {
          a.setAttribute("onclick", "toggleSidebar('#overlay-menu')");
        });
      </script>

      <!-- search functionalities -->
      <aside id="overlay-search">
        <div class="search">
          <div>
            <span class="button search" onclick="document.querySelector('#search-input').focus()"></span>
            <input
              autocomplete="off"
              id="search-input"
              onkeyup="lunrSearch()"
              placeholder="search with lunr"
              type="text"
            >
            <span class="button reset" onclick="resetSearch()"></span>
          </div>
          <ul id="search-output"></ul>
        </div>
      </aside>

      <!-- actual content -->
      <article>{{ content }}</article>

    </main>

  </body>

</html>
